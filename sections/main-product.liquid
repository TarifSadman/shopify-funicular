{% assign current_variant = product.selected_or_first_available_variant %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 py-12">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
    <!-- Image Section -->
    <div class="product-images">
      <!-- Main Swiper -->
      <div class="swiper product-main-swiper border bg-white overflow-hidden">
        <div class="swiper-wrapper">
          {% for media in product.media %}
            <div class="swiper-slide" data-media-id="{{ media.id }}">
              {% if media.media_type == 'image' %}
                <img
                  src="{{ media.preview_image | image_url: width: 800 }}"
                  alt="{{ media.alt | escape }}"
                  width="800"
                  height="800"
                  class="w-full h-full object-contain"
                  loading="lazy"
                >
              {% else %}
                {{ media | media_tag: class: 'w-full h-full object-contain' }}
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <!-- Custom Navigation -->
        <div class="swiper-button-next custom-swiper-nav">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8">
            <path d="M10 20A10 10 0 1 0 0 10a10 10 0 0 0 10 10zM8.711 4.3l5.7 5.766L8.7 15.711l-1.4-1.422 4.289-4.242-4.3-4.347z"/>
          </svg>
        </div>
        <div class="swiper-button-prev custom-swiper-nav">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8 rotate-180">
            <path d="M10 20A10 10 0 1 0 0 10a10 10 0 0 0 10 10zM8.711 4.3l5.7 5.766L8.7 15.711l-1.4-1.422 4.289-4.242-4.3-4.347z"/>
          </svg>
        </div>
      </div>

      <div class="swiper product-thumb-swiper mt-4">
        <div class="swiper-wrapper">
          {% for media in product.media %}
            <div class="swiper-slide cursor-pointer" data-media-id="{{ media.id }}">
              <div class="border overflow-hidden shrink-0">
                <img
                  src="{{ media.preview_image | image_url: width: 200 }}"
                  alt="{{ media.alt | escape }}"
                  width="200"
                  height="200"
                  class="w-full aspect-square object-cover"
                  loading="lazy"
                >
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="flex flex-col">
      {% for block in section.blocks %}
        {% case block.type %}
          {% when '@app' %}
            {% render block %}

          {% when 'title' %}
            <h1 class="text-3xl font-semibold text-gray-900" {{ block.shopify_attributes }}>
              {{ product.title }}
            </h1>

          {% when 'price' %}
            <div class="mt-3" {{ block.shopify_attributes }}>
              <p class="text-2xl font-medium text-gray-900">
                {{ current_variant.price | money }}
              </p>
            </div>

          {% when 'variant_selector' %}
            <div class="mt-6" {{ block.shopify_attributes }}>
              {% unless product.has_only_default_variant %}
                <div class="variant-selects" data-section="{{ section.id }}">
                  {% for option in product.options_with_values %}
                    <div class="mb-4">
                      <label
                        for="Option-{{ section.id }}-{{ forloop.index0 }}"
                        class="block text-sm font-medium text-gray-700 mb-1"
                      >
                        {{ option.name }}
                      </label>
                      <select
                        id="Option-{{ section.id }}-{{ forloop.index0 }}"
                        class="variant-option w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-1 focus:ring-black"
                      >
                        {% for value in option.values %}
                          <option
                            value="{{ value | escape }}"
                            {% if option.selected_value == value %}
                              selected
                            {% endif %}
                          >
                            {{ value }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  {% endfor %}

                  <script type="application/json" id="VariantData-{{ section.id }}">
                    {{ product.variants | json }}
                  </script>
                </div>

                <script>
                  (function () {
                    const sectionId = '{{ section.id }}';
                    const container = document.querySelector(`.variant-selects[data-section="${sectionId}"]`);
                    const variantData = JSON.parse(document.getElementById(`VariantData-${sectionId}`).textContent);
                    const selects = container.querySelectorAll('.variant-option');

                    function updateVariant() {
                      const selectedOptions = Array.from(selects).map((select) => select.value);
                      const matchedVariant = variantData.find((variant) => {
                        return variant.options.every((option, index) => option === selectedOptions[index]);
                      });

                      if (matchedVariant) {
                        // Update hidden input
                        const input = document.querySelector(`#AddToCartForm-${sectionId} input[name="id"]`);
                        if (input) input.value = matchedVariant.id;

                        // Update price
                        const priceElement = document.querySelector('.text-2xl.font-medium.text-gray-900');
                        if (priceElement) {
                          // Simple formatting fallback
                          priceElement.innerText = (matchedVariant.price / 100).toLocaleString('en-US', {
                            style: 'currency',
                            currency: 'USD',
                          });
                        }

                        // Update URL without reload
                        const url = new URL(window.location);
                        url.searchParams.set('variant', matchedVariant.id);
                        window.history.replaceState({}, '', url);

                        // Update button state
                        const addButton = document.getElementById(`AddToCart-${sectionId}`);
                        if (addButton) {
                          if (matchedVariant.available) {
                            addButton.disabled = false;
                            addButton.innerText = 'Add to cart';
                          } else {
                            addButton.disabled = true;
                            addButton.innerText = 'Sold out';
                          }
                        }

                        // Update Swiper to match variant image
                        const featuredMedia = matchedVariant.featured_media || matchedVariant.featured_image;
                        if (featuredMedia && window.productMainSwiper) {
                          const mediaId = featuredMedia.id;
                          const slides = document.querySelectorAll('.product-main-swiper .swiper-slide');
                          const targetIndex = Array.from(slides).findIndex((slide) => slide.dataset.mediaId == mediaId);

                          if (targetIndex !== -1) {
                            window.productMainSwiper.slideTo(targetIndex);
                          }
                        }
                      }
                    }

                    selects.forEach((select) => select.addEventListener('change', updateVariant));
                  })();
                </script>
              {% endunless %}
            </div>

          {% when 'quantity_selector' %}
            <div class="mt-6 flex items-center gap-4" {{ block.shopify_attributes }}>
              <label for="Quantity-{{ section.id }}" class="text-sm font-medium text-gray-700"> Qty </label>
              <input
                type="number"
                id="Quantity-{{ section.id }}"
                name="quantity"
                value="1"
                min="1"
                class="w-20 border px-3 py-2 text-center focus:outline-none focus:ring-2 focus:ring-black"
                form="AddToCartForm-{{ section.id }}"
              >
            </div>

          {% when 'buy_buttons' %}
            <div class="mt-8" {{ block.shopify_attributes }}>
              <form
                id="AddToCartForm-{{ section.id }}"
                action="{{ routes.cart_add_url }}"
                method="post"
                enctype="multipart/form-data"
              >
                <input type="hidden" name="id" value="{{ current_variant.id }}">
                <button
                  type="submit"
                  name="add"
                  id="AddToCart-{{ section.id }}"
                  class="w-full bg-black text-white py-4 text-lg font-semibold hover:bg-gray-900 transition"
                  {% unless current_variant.available %}
                    disabled
                  {% endunless %}
                >
                  {% if current_variant.available %}Add to cart{% else %}Sold out{% endif %}
                </button>
              </form>
            </div>

          {% when 'description' %}
            <div class="mt-12" {{ block.shopify_attributes }}>
              <h2 class="text-xl font-semibold mb-4">Product Details</h2>
              <div class="prose prose-gray max-w-none">
                {{ product.description }}
              </div>
            </div>

          {% when 'faq' %}
            {% assign faq_questions = product.metafields.custom.faq_questions.value %}
            {% assign faq_answers = product.metafields.custom.faq_answers.value %}
            {% if faq_questions != blank %}
              <div class="mt-16" {{ block.shopify_attributes }}>
                <h2 class="text-xl font-semibold mb-6">Frequently Asked Questions</h2>
                <div class="divide-y border-t">
                  {% for question in faq_questions %}
                    {% assign index = forloop.index0 %}
                    {% assign answer = faq_answers[index] %}
                    <details class="py-4 group">
                      <summary class="flex justify-between items-center cursor-pointer text-gray-900 font-medium">
                        <span>{{ question }}</span>
                        <span class="transition group-open:rotate-180">âŒ„</span>
                      </summary>
                      <div class="mt-3 text-gray-600 leading-relaxed">
                        {{ answer }}
                      </div>
                    </details>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

          {% when 'tags' %}
            {% if product.tags.size > 0 %}
              <div class="mt-2 flex flex-wrap gap-2" {{ block.shopify_attributes }}>
                {% for tag in product.tags %}
                  <span class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium bg-red-100 text-red-800">
                    {{ tag }}
                  </span>
                {% endfor %}
              </div>
            {% endif %}
        {% endcase %}
      {% endfor %}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Main Product",
  "settings": [],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "title",
      "name": "Title",
      "limit": 1
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1
    },
    {
      "type": "variant_selector",
      "name": "Variant Selector",
      "limit": 1
    },
    {
      "type": "quantity_selector",
      "name": "Quantity Selector",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Buy Buttons",
      "limit": 1
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1
    },
    {
      "type": "faq",
      "name": "FAQ",
      "limit": 1
    },
    {
      "type": "tags",
      "name": "Tags",
      "limit": 1
    }
  ],
  "presets": [
    {
      "name": "Main Product",
      "blocks": [
        { "type": "title" },
        { "type": "tags" },
        { "type": "price" },
        { "type": "variant_selector" },
        { "type": "quantity_selector" },
        { "type": "buy_buttons" },
        { "type": "description" },
        { "type": "faq" }
      ]
    }
  ]
}
{% endschema %}
