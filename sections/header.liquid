{%- comment -%} Removed unused main_menu_linklist variable {%- endcomment -%}

<div class="relative bg-slate-900 border-b border-slate-800" x-data="{ mobileMenuOpen: false }">
  <div class="mx-auto max-w-7xl px-4 sm:px-6">
    <div class="flex items-center justify-between py-4 md:space-x-10">
      <!-- STORE NAME / LOGO -->
      <div class="flex items-center lg:flex-1 min-w-0">
        <a href="{{ routes.root_url }}" class="flex items-center gap-2">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center">
            <span class="text-white font-bold text-lg">â—†</span>
          </div>
          <h1 class="text-lg font-semibold tracking-tight text-white truncate">
            {{ shop.name }}
          </h1>
        </a>
      </div>

      <!-- DESKTOP NAV -->
      <nav class="hidden md:flex items-center space-x-8">
        {% for link in linklists['main-menu'].links %}
          {% if link.links != blank %}
            <div class="relative" x-data="{ open: false }">
              <button
                @click="open = !open"
                type="button"
                class="inline-flex items-center gap-1 text-sm font-medium text-slate-300 hover:text-white transition cursor-pointer"
              >
                {{ link.title }}
                <svg
                  class="w-4 h-4 transition-transform"
                  :class="{ 'rotate-180': open }"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 -19.04 75.804 75.804"
                  fill="currentColor"
                >
                  <path
                    d="M0.003,1.499A1.5,1.5,0,0,1,2.564.439L36.124,34a2.528,2.528,0,0,0,3.564,0L73.246.439a1.5,1.5,0,1,1,2.121,2.121L41.809,36.117a5.53,5.53,0,0,1-7.807,0L.442,2.56A1.5,1.5,0,0,1,.003,1.499Z"
                  />
                </svg>
              </button>

              <div
                x-show="open"
                x-cloak
                @click.away="open = false"
                x-transition
                class="absolute left-0 z-20 mt-3 w-48 px-0"
              >
                <div class="border border-slate-700 bg-slate-800 shadow-xl">
                  <div class="grid gap-0 p-3">
                    {% for childlink in link.links %}
                      <a
                        href="{{ childlink.url }}"
                        class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition"
                      >
                        {{ childlink.title }}
                      </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>

          {% else %}
            <a
              href="{{ link.url }}"
              class="text-sm font-medium text-slate-300 hover:text-white transition"
            >
              {{ link.title }}
            </a>
          {% endif %}
        {% endfor %}
      </nav>

      <!-- RIGHT ACTIONS -->
      <div class="flex items-center justify-end gap-3 md:gap-5 md:flex-1">
        <!-- SEARCH INPUT (Desktop Only) -->
        <div class="hidden md:block relative group" x-data="searchModule()">
          <div class="relative">
            <input
              type="text"
              x-model="searchQuery"
              @input="handleSearch()"
              @keydown.enter="navigateToFirstResult()"
              placeholder="Search..."
              class="w-48 lg:w-64 bg-slate-800 text-slate-200 placeholder-slate-400 px-4 py-2 pl-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300"
            >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.5 5.5a7.5 7.5 0 0010.5 10.5Z"
              />
            </svg>
          </div>

          <div
            x-show="searchQuery && (searchResults.length > 0 || isLoading)"
            x-cloak
            x-transition
            class="absolute top-full right-0 mt-2 w-96 bg-white shadow-xl border border-slate-200 max-h-96 overflow-y-auto z-50 rounded-b-md"
          >
            <!-- LOADING -->
            <div
              x-show="isLoading"
              class="flex items-center justify-center gap-2 px-4 py-6"
            >
              <svg
                class="animate-spin h-4 w-4 text-blue-600"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-sm text-slate-500">Searching...</span>
            </div>

            <!-- RESULTS -->
            <template x-for="(product, index) in searchResults" :key="product.id">
              <a
                :href="product.url"
                class="flex items-center gap-3 px-4 py-3 hover:bg-slate-50 border-b border-slate-100 last:border-b-0 transition"
              >
                <img
                  :src="product.image"
                  :alt="product.title"
                  width="48"
                  height="48"
                  class="w-12 h-12 object-cover rounded"
                  loading="lazy"
                >
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-slate-900 truncate" x-text="product.title"></p>
                  <p class="text-xs text-slate-500 mt-0.5" x-text="formatPrice(product.price)"></p>
                </div>
              </a>
            </template>
          </div>
        </div>

        <!-- ACCOUNT -->
        {% if shop.customer_accounts_enabled %}
          <div class="relative" x-data="{ accountOpen: false }">
            <button
              @click="accountOpen = !accountOpen"
              @mouseenter="accountOpen = true"
              class="flex cursor-pointer items-center text-slate-300 hover:text-white transition py-2"
              aria-label="Account"
            >
              {% render 'icon_user' %}
            </button>

            <div
              x-show="accountOpen"
              x-cloak
              @mouseleave="accountOpen = false"
              @click.away="accountOpen = false"
              x-transition
              class="absolute right-0 z-50 mt-1 w-48 bg-slate-800 border border-slate-700 shadow-2xl rounded-sm"
            >
              <div class="py-2">
                {% if customer %}
                  <a
                    href="{{ routes.account_url }}"
                    class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition"
                  >
                    My Account
                  </a>
                  <a
                    href="{{ routes.account_logout_url }}"
                    class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition"
                  >
                    Log out
                  </a>
                {% else %}
                  <a
                    href="{{ routes.account_login_url }}"
                    class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition font-medium"
                  >
                    Log in
                  </a>
                  <a
                    href="{{ routes.account_register_url }}"
                    class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white transition"
                  >
                    Create account
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}

        <!-- WISHLIST POPUP -->
        <div
          class="relative group"
          x-data="{ wishlistOpen: false }"
          @mouseenter="wishlistOpen = true; updateWishlistDrawer();"
          @mouseleave="wishlistOpen = false"
        >
          <a
            href="#"
            class="relative flex items-center text-slate-300 hover:text-white transition p-2"
            aria-label="Wishlist"
            onclick="event.preventDefault();"
          >
            {% render 'icon_heart', class: 'w-6 h-6', fill: false %}
            <sup
              id="WishlistCount"
              data-currency="{{ cart.currency.iso_code }}"
              class="absolute -top-1 -right-1 flex items-center justify-center bg-red-500 text-white text-[10px] font-bold rounded-full w-4 h-4 hidden"
            >
              0
            </sup>
          </a>

          <!-- Popup Content -->
          <div
            x-show="wishlistOpen"
            x-cloak
            x-transition
            class="absolute right-0 z-50 mt-1 w-80 bg-slate-800 border border-slate-700 shadow-2xl rounded-sm overflow-hidden"
          >
            <div class="p-4 border-b border-slate-700">
              <h3 class="text-sm font-bold text-white uppercase tracking-wider">My Wishlist</h3>
            </div>
            <div id="WishlistContent" class="max-h-96 overflow-y-auto p-2">
              <!-- Dynamic content from JS -->
              <div class="text-center py-10 text-slate-400 text-xs">
                <p>Your wishlist is empty</p>
              </div>
            </div>
          </div>
        </div>

        <!-- CART -->
        <a
          href="{{ routes.cart_url }}"
          class="relative flex items-center text-slate-300 hover:text-white transition p-2"
          aria-label="Cart"
          onclick="event.preventDefault(); openSideCart();"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"
            />
          </svg>

          <sup
            id="CartCount"
            class="absolute -top-1 -right-1 flex items-center justify-center bg-blue-600 text-white text-[10px] font-bold rounded-full w-4 h-4 {% if cart.item_count == 0 %}hidden{% endif %}"
          >
            {{ cart.item_count }}
          </sup>
        </a>

        <!-- MOBILE HAMBURGER -->
        <div class="md:hidden">
          <button
            x-on:click="mobileMenuOpen = !mobileMenuOpen"
            type="button"
            class="inline-flex items-center justify-center p-2 text-slate-400 hover:bg-slate-800 hover:text-white focus:outline-none"
          >
            {% render 'icon_hamburger' %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MOBILE MENU -->
  <div
    x-show="mobileMenuOpen"
    x-cloak
    x-transition
    class="absolute inset-x-0 top-full z-30 md:hidden"
  >
    <div class="mx-2 mt-2 bg-slate-800 shadow-xl border border-slate-700">
      <div class="divide-y divide-slate-700 p-5">
        <!-- MOBILE HEADER -->
        <div class="flex items-center justify-between pb-4">
          <h2 class="text-sm font-medium text-slate-400">
            {{ section.settings.mobile_menu_title }}
          </h2>

          <button
            x-on:click="mobileMenuOpen = false"
            type="button"
            class="p-2 text-slate-400 hover:bg-slate-700 hover:text-white"
          >
            {% render 'icon_close' %}
          </button>
        </div>

        <!-- MOBILE NAV -->
        <div class="pt-4">
          <nav class="grid gap-y-4">
            {% for link in linklists['main-menu'].links %}
              {% assign link_handle = link.handle | replace: '-', '_' %}

              {% if link.links != blank %}
                <div x-data="{ {{ link_handle }}: false }">
                  <button
                    x-on:click="{{ link_handle }} = !{{ link_handle }}"
                    type="button"
                    class="flex w-full items-center justify-between text-sm font-medium text-slate-300 hover:text-white transition"
                  >
                    {{ link.title }}
                    <svg
                      class="w-4 h-4 transition-transform"
                      :class="{ 'rotate-180': {{ link_handle }} }"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 -19.04 75.804 75.804"
                      fill="currentColor"
                    >
                      <path
                        d="M0.003,1.499A1.5,1.5,0,0,1,2.564.439L36.124,34a2.528,2.528,0,0,0,3.564,0L73.246.439a1.5,1.5,0,1,1,2.121,2.121L41.809,36.117a5.53,5.53,0,0,1-7.807,0L.442,2.56A1.5,1.5,0,0,1,.003,1.499Z"
                      />
                    </svg>
                  </button>

                  <div x-show="{{ link_handle }}" x-cloak x-transition class="mt-3 space-y-2 pl-4">
                    {% for childlink in link.links %}
                      <a
                        href="{{ childlink.url }}"
                        class="block px-3 py-2 text-sm text-slate-400 hover:bg-slate-700 hover:text-white transition"
                      >
                        {{ childlink.title }}
                      </a>
                    {% endfor %}
                  </div>
                </div>
              {% else %}
                <a
                  href="{{ link.url }}"
                  class="block px-3 py-2 text-sm font-medium text-slate-300 hover:bg-slate-700 hover:text-white transition"
                >
                  {{ link.title }}
                </a>
              {% endif %}
            {% endfor %}
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function searchModule() {
    return {
      searchQuery: '',
      searchResults: [],
      isLoading: false,
      debounceTimer: null,

      formatPrice(price) {
        const amount = parseFloat(price);
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: '{{ cart.currency.iso_code }}' || 'USD',
        }).format(amount);
      },

      navigateToFirstResult() {
        if (this.searchResults.length > 0) {
          window.location.href = this.searchResults[0].url;
        }
      },

      async handleSearch() {
        clearTimeout(this.debounceTimer);

        this.debounceTimer = setTimeout(async () => {
          const query = this.searchQuery.trim();

          if (!query) {
            this.searchResults = [];
            return;
          }

          this.isLoading = true;

          try {
            // Use Shopify's Predictive Search API
            const response = await fetch(
              `/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=8`
            );

            if (!response.ok) {
              throw new Error('Search failed');
            }

            const data = await response.json();
            const products = data.resources?.results?.products || [];

            this.searchResults = products.map((product) => ({
              id: product.id,
              title: product.title,
              price: product.price,
              compareAtPrice: product.compare_at_price,
              image:
                product.image ||
                product.featured_image ||
                'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png',
              url: product.url,
              available: product.available,
            }));
          } catch (error) {
            console.error('Search error:', error);

            // Fallback to products.json for development/testing
            try {
              const fallbackResponse = await fetch('/products.json');
              const productsData = await fallbackResponse.json();
              const lowerQuery = query.toLowerCase();

              this.searchResults = productsData.products
                .filter(
                  (p) =>
                    p.title.toLowerCase().includes(lowerQuery) ||
                    (p.tags && p.tags.some((tag) => tag.toLowerCase().includes(lowerQuery)))
                )
                .slice(0, 8)
                .map((p) => ({
                  id: p.id,
                  title: p.title,
                  price: p.variants[0]?.price || 0,
                  compareAtPrice: p.variants[0]?.compare_at_price,
                  image:
                    (p.images && p.images[0] ? p.images[0].src || p.images[0] : p.featured_image) ||
                    'https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-image_large.png',
                  url: `/products/${p.handle}`,
                  available: p.available,
                }));
            } catch (fallbackError) {
              console.error('Fallback search error:', fallbackError);
              this.searchResults = [];
            }
          } finally {
            this.isLoading = false;
          }
        }, 300);
      },
    };
  }
</script>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "text",
      "id": "mobile_menu_title",
      "label": "Title",
      "info": "This is the title of mobile menu",
      "default": "menu"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Header",
      "default": "main-menu"
    }
  ]
}
{% endschema %}
